<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Cupons Fiscais</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .description {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .main-content {
            display: block;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            margin-bottom: 20px;
        }

        #generate-pdf-btn {
            background-color: #2ecc71;
            /* Cor diferente para o botão de PDF */
        }

        #generate-pdf-btn:hover {
            background-color: #27ae60;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        .upload-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        #file-input,
        #mobile-file-input {
            display: none;
        }

        #qrcode {
            margin: 15px auto;
            display: inline-block;
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
        }

        .connection-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .status-connecting {
            background: #fff3cd;
            color: #856404;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .processing {
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #processing-status {
            color: #555;
            font-style: italic;
        }

        .results-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
            display: none;
        }

        .raw-text-section,
        .parsed-data-section {
            flex: 1;
            min-width: 300px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .raw-text-section {
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 600px;
            overflow: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .results h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaeaea;
        }

        .store-info,
        .sale-info,
        .payment-info {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .products-table th,
        .products-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .products-table th {
            background: #e8f4fc;
        }

        .products-table .total-row {
            font-weight: bold;
            background: #f1f8fe;
        }

        .info-item {
            display: flex;
            margin-bottom: 8px;
        }

        .info-label {
            font-weight: bold;
            min-width: 150px;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
        }

        .mobile-view {
            display: none;
            text-align: center;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .info-item {
                flex-direction: column;
            }

            .info-label {
                margin-bottom: 5px;
            }

            .results-container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">

        <div id="desktop-view">
            <header>
                <h1>Leitor de Cupons Fiscais</h1>
                <p class="description">Envie cupons fiscais via celular (QR Code) ou arquivo local</p>
            </header>

            <section class="upload-section">
                <button class="upload-btn" id="local-file-btn">Adicionar por arquivo local</button>
                <input type="file" id="file-input" accept=".jpg,.jpeg,.png">
                <button class="upload-btn" id="start-qr-btn">Adicionar por celular (QR Code)</button>

                <div id="qrcode-container" style="display: none;">
                    <h3>Escaneie com seu celular para conectar</h3>
                    <canvas id="qrcode"></canvas>
                    <div class="connection-status" id="connection-status">
                        <span id="status-text"></span>
                    </div>
                </div>
            </section>
        </div>

        <div id="mobile-view" class="mobile-view">
            <header>
                <h1>Enviar Cupom Fiscal</h1>
                <p class="description">Selecione o arquivo para enviar ao computador.</p>
            </header>
            <div class="connection-status" id="mobile-connection-status">
                <span id="mobile-status-text">Conectando...</span>
            </div>
            <br>
            <button class="upload-btn" id="mobile-file-trigger" disabled>Selecionar Arquivo</button>
            <input type="file" id="mobile-file-input" accept=".jpg,.jpeg,.png">
        </div>

        <div class="processing" id="processing">
            <div class="spinner"></div>
            <p id="processing-status">Processando cupom fiscal...</p>
        </div>

        <div class="results-container" id="results-container">
            <div class="parsed-data-section">
                <h2>Dados Processados</h2>
                <div class="store-info">
                    <h3>Empresa Vendedora</h3>
                    <div class="info-item"><span class="info-label">Nome:</span><span id="store-name">-</span></div>
                    <div class="info-item"><span class="info-label">CNPJ:</span><span id="store-cnpj">-</span></div>
                    <div class="info-item"><span class="info-label">Endereço:</span><span id="store-address">-</span>
                    </div>
                </div>
                <h3>Produtos</h3>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Descrição</th>
                            <th>Qtd.</th>
                            <th>UN</th>
                            <th>Vl. Unit.</th>
                            <th>Vl. Item R$</th>
                        </tr>
                    </thead>
                    <tbody id="products-list"></tbody>
                </table>
                <div class="sale-info">
                    <h3>Resumo da Venda</h3>
                    <div class="info-item"><span class="info-label">Qtd. total de itens:</span><span
                            id="total-items">-</span></div>
                    <div class="info-item"><span class="info-label">Valor total:</span><span id="total-value">-</span>
                    </div>
                    <div class="info-item"><span class="info-label">Operador:</span><span id="operator">-</span></div>
                </div>
                <div class="payment-info">
                    <h3>Informações de Pagamento</h3>
                    <div class="info-item"><span class="info-label">Tipo:</span><span id="payment-type">-</span></div>
                    <div class="info-item"><span class="info-label">Troco:</span><span id="change">-</span></div>
                </div>
            </div>
        </div>

        <div class="success-msg" id="success-message">
            Cupom fiscal processado com sucesso!
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="upload-btn" id="generate-pdf-btn" style="display: none;">Gerar PDF</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos da UI
            const processingSection = document.getElementById('processing');
            const processingStatus = document.getElementById('processing-status');
            const resultsContainer = document.getElementById('results-container');
            const successMsg = document.getElementById('success-message');
            const productsList = document.getElementById('products-list');
            const desktopView = document.getElementById('desktop-view');
            const startQrBtn = document.getElementById('start-qr-btn');
            const localFileBtn = document.getElementById('local-file-btn');
            const fileInput = document.getElementById('file-input');
            const qrcodeContainer = document.getElementById('qrcode-container');
            const connectionStatus = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            const mobileView = document.getElementById('mobile-view');
            const mobileFileTrigger = document.getElementById('mobile-file-trigger');
            const mobileFileInput = document.getElementById('mobile-file-input');
            const mobileConnectionStatus = document.getElementById('mobile-connection-status');
            const mobileStatusText = document.getElementById('mobile-status-text');
            const generatePdfBtn = document.getElementById('generate-pdf-btn');

            let peer = null;
            let connection = null;
            const urlParams = new URLSearchParams(window.location.search);
            const connectToId = urlParams.get('connect');

            //Variável para armazenar os dados do cupom para o PDF
            let parsedReceiptData = null;

            if (connectToId) {
                initializeMobileSender(connectToId);
            } else {
                initializeDesktopReceiver();
            }

            function initializeDesktopReceiver() {
                desktopView.style.display = 'block';
                mobileView.style.display = 'none';

                startQrBtn.addEventListener('click', () => {
                    startQrBtn.disabled = true;
                    localFileBtn.disabled = true;
                    qrcodeContainer.style.display = 'block';
                    updateStatus('connecting', 'Iniciando conexão...');

                    peer = new Peer();
                    const serverIp = window.location.hostname;
                    peer.on('open', (id) => {
                        const url = `http://${serverIp}:8000?connect=${id}`;
                        QRCode.toCanvas(document.getElementById('qrcode'), url, { width: 220 });
                        updateStatus('connecting', 'Aguardando conexão do celular...');
                    });

                    peer.on('connection', (conn) => {
                        connection = conn;
                        updateStatus('connected', 'Celular conectado! Aguardando arquivo...');

                        conn.on('data', (data) => {
                            if (data.type === 'file') {
                                updateStatus('connected', `Recebendo arquivo: ${data.name}`);
                                const file = dataURLtoFile(data.dataUrl, data.name);
                                processFile(file);
                                desktopView.style.display = 'none';
                            }
                        });

                        conn.on('close', () => {
                            updateStatus('error', 'Conexão perdida.');
                            resetDesktopState();
                        });
                    });

                    peer.on('error', (err) => {
                        console.error(err);
                        updateStatus('error', `Erro: ${err.type}. Tente novamente.`);
                        resetDesktopState();
                    });
                });

                localFileBtn.addEventListener('click', () => fileInput.click());

                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        desktopView.style.display = 'none';
                        processFile(file);
                    }
                });
            }

            function updateStatus(type, message) {
                connectionStatus.className = `connection-status status-${type}`;
                statusText.textContent = message;
            }

            function resetDesktopState() {
                startQrBtn.disabled = false;
                localFileBtn.disabled = false;
                qrcodeContainer.style.display = 'none';
                if (peer) peer.destroy();
            }

            function initializeMobileSender(desktopId) {
                desktopView.style.display = 'none';
                mobileView.style.display = 'block';

                peer = new Peer();

                peer.on('open', (id) => {
                    updateMobileStatus('connecting', 'Conectando ao computador...');
                    connection = peer.connect(desktopId);

                    connection.on('open', () => {
                        updateMobileStatus('connected', 'Conectado! Pronto para enviar.');
                        mobileFileTrigger.disabled = false;
                    });

                    connection.on('error', (err) => {
                        console.error(err);
                        updateMobileStatus('error', 'Erro de conexão.');
                    });
                });

                peer.on('error', (err) => {
                    console.error(err);
                    updateMobileStatus('error', `Erro: ${err.type}.`);
                });

                mobileFileTrigger.addEventListener('click', () => mobileFileInput.click());

                mobileFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && connection) {
                        sendFile(file);
                    }
                });
            }

            function sendFile(file) {
                const reader = new FileReader();

                reader.onload = (event) => {
                    const payload = {
                        type: 'file',
                        name: file.name,
                        dataUrl: event.target.result
                    };

                    connection.send(payload);
                    updateMobileStatus('connected', `Arquivo "${file.name}" enviado com sucesso!`);
                    mobileFileTrigger.disabled = true;
                };

                updateMobileStatus('connecting', `Enviando "${file.name}"...`);
                reader.readAsDataURL(file);
            }

            function updateMobileStatus(type, message) {
                mobileConnectionStatus.className = `connection-status status-${type}`;
                mobileStatusText.textContent = message;
            }

            async function processFile(file) {
                processingSection.style.display = 'block';
                resultsContainer.style.display = 'none';
                successMsg.style.display = 'none';
                generatePdfBtn.style.display = 'none'; // Esconde o botão durante o processamento
                processingStatus.textContent = 'Enviando imagem para o servidor...';
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch('/process-image', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) {
                        throw new Error(`Erro do servidor: ${response.statusText}`);
                    }
                    const result = await response.json();
                    processingStatus.textContent = 'Analisando dados do cupom...';

                    console.log(result.text)

                    parsedReceiptData = parseReceiptText(result.text);

                    updateResults(parsedReceiptData);
                    processingSection.style.display = 'none';
                    resultsContainer.style.display = 'flex';
                    successMsg.style.display = 'block';
                    generatePdfBtn.style.display = 'inline-block'; // Mostra o botão após sucesso
                } catch (error) {
                    console.error('Erro no processamento:', error);
                    processingSection.style.display = 'none';
                    alert('Não foi possível processar a imagem. Verifique o console do navegador e do terminal Flask para mais detalhes.');
                    resetDesktopState();
                }
            }

            function parseReceiptText(text) {
                // Função auxiliar para executar um regex e retornar o resultado ou um valor padrão.
                const extract = (pattern, text, group = 1) => {
                    const match = text.match(pattern);
                    return match ? (match[group] || '').trim() : null;
                };

                const patterns = {
                    storeName: /^(.*)$/m,
                    cnpj: /(\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2})/i,
                    address: /^.*\n([\s\S]*?)\n.*CNPJ/i,

                    itemLine: /^\d+\s+(\d+)\s+(.*?)\n(\d*)\s?UN\s*X\s*([\d,.]+)\n([\d,.]+)$/gm,

                    totalValue: /(?:VALOR\s*TOTAL|TOTAL\s*R\$)\s*[\s\S]*?([\d,.]+)/i,

                    totalItems: /Qtde\.\s*Total\s*Itens\s*.*?(\d+)/i,

                    operator: /Operador:\s*\d+-(.*)/i,

                    paymentType: /(Cart(a|ã)o de Cr(e|é)dito|DINHEIRO|DEBITO)/i
                };

                // --- Extração das Informações ---

                // Lógica para formatar o CNPJ
                let cnpj = extract(patterns.cnpj, text) || "Não encontrado";
                if (cnpj && cnpj.length >= 14) {
                    const digits = cnpj.replace(/\D/g, ''); // Remove tudo que não for dígito
                    if (digits.length === 14) {
                        // Aplica a formatação padrão
                        cnpj = digits.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                    }
                }

                const storeInfo = {
                    name: extract(patterns.storeName, text) || "Não encontrado",
                    cnpj: cnpj,
                    address: extract(patterns.address, text) || "Não encontrado"
                };

                const products = [];
                let match;
                while ((match = patterns.itemLine.exec(text)) !== null) {
                    products.push({
                        code: match[1].trim(),
                        description: match[2].trim(),
                        quantity: match[3].trim() || '1',
                        unit: 'UN',
                        unitValue: match[4].trim().replace('.', ','),
                        itemValue: match[5].trim().replace('.', ',')
                    });
                }

                const totalValueText = (extract(patterns.totalValue, text) || '0,00').replace('.', ',');

                const saleInfo = {
                    operator: extract(patterns.operator, text) || "Não encontrado",
                    totalItems: extract(patterns.totalItems, text) || products.length.toString()
                };

                const paymentInfo = {
                    type: extract(patterns.paymentType, text) || "Não encontrado",
                    change: "0,00"
                };

                return { storeInfo, products, saleInfo, paymentInfo, totalValue: totalValueText };
            }
            function updateResults(receiptData) {
                const { storeInfo, products, saleInfo, paymentInfo, totalValue } = receiptData;

                document.getElementById('store-name').textContent = storeInfo.name;
                document.getElementById('store-cnpj').textContent = storeInfo.cnpj;
                document.getElementById('store-address').textContent = storeInfo.address;

                productsList.innerHTML = '';

                if (products.length > 0) {
                    products.forEach(product => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.code}</td>
                            <td>${product.description}</td>
                            <td>${product.quantity}</td>
                            <td>${product.unit}</td>
                            <td>R$ ${product.unitValue}</td>
                            <td>R$ ${product.itemValue}</td>
                        `;
                        productsList.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="6" style="text-align: center;">Nenhum produto identificado</td>`;
                    productsList.appendChild(row);
                }

                const totalItems = saleInfo.totalItems;
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row';
                totalRow.innerHTML = `<td colspan="2">TOTAL</td><td>${totalItems}</td><td></td><td></td><td>R$ ${totalValue}</td>`;
                productsList.appendChild(totalRow);

                document.getElementById('total-items').textContent = totalItems;
                document.getElementById('total-value').textContent = `R$ ${totalValue}`;
                document.getElementById('operator').textContent = saleInfo.operator;
                document.getElementById('payment-type').textContent = paymentInfo.type;
                document.getElementById('change').textContent = `R$ ${paymentInfo.change}`;
            }

            function dataURLtoFile(dataurl, filename) {
                const arr = dataurl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);

                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }

                return new File([u8arr], filename, { type: mime });
            }

            generatePdfBtn.addEventListener('click', async () => {
                if (!parsedReceiptData) {
                    alert('Não há dados de cupom para gerar o PDF.');
                    return;
                }

                generatePdfBtn.disabled = true;
                generatePdfBtn.textContent = 'Gerando...';

                try {
                    const response = await fetch('/generate-pdf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(parsedReceiptData)
                    });

                    if (!response.ok) {
                        throw new Error('Falha ao gerar o PDF no servidor.');
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'cupom_fiscal.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    alert('Ocorreu um erro ao gerar o PDF.');
                } finally {
                    generatePdfBtn.disabled = false;
                    generatePdfBtn.textContent = 'Gerar PDF';
                }
            });
        });
    </script>
</body>

</html>
